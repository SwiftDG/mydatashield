<%- include('partials/header') %>

    <div class="container py-4">
        <!-- Dashboard Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="dashboard-title">My Data Dashboard</h1>
                <p class="dashboard-subtitle">Manage your data consents and privacy settings</p>
            </div>
            <div class="col-auto">
                <div class="pro-card">
                    <div class="card-body py-2 text-center">
                        <small class="text-muted">Privacy Score</small>
                        <h4 class="mb-0 text-success"><%= privacyScore || 0 %>%</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="card-body text-center py-3">
                        <h5 class="mb-1"><%= consents ? consents.length : 0 %></h5>
                        <small>Organizations</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card success">
                    <div class="card-body text-center py-3">
                        <h5 class="mb-1">
                            <%= consents ? consents.filter(c => c.consent_given).length : 0 %>
                        </h5>
                        <small>Active Consents</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card warning">
                    <div class="card-body text-center py-3">
                        <h5 class="mb-1">
                            <%= consents ? consents.filter(c => !c.consent_given).length : 0 %>
                        </h5>
                        <small>Pending</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card info">
                    <div class="card-body text-center py-3">
                        <h5 class="mb-1"><%= dataRightsUsed || 0 %></h5>
                        <small>Data Rights Used</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Consent Management -->
        <div class="row">
            <div class="col-lg-8">
                <div class="pro-card consent-one">
                    <div class="pro-card-header consent-two">
                        <h5 class="mb-0">My Data Consents</h5>
                    </div>
                    <div class="pro-card-body">
                        <% if (consents && consents.length > 0) { %>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Organization</th>
                                            <th>Consent Status</th>
                                            <th>Data Categories</th>
                                            <th>Last Updated</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="custom-two">
                                        <% consents.forEach(consent => { %>
                                            <tr class="custom-three">
                                                <td>
                                                    <strong><%= consent.organization_name || 'Unknown Organization' %></strong>
                                                </td>
                                                <td>
                                                    <% if (consent.consent_given) { %>
                                                        <span class="badge bg-success">Approved</span>
                                                    <% } else { %>
                                                        <span class="badge bg-warning">Pending</span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <small>
                                                        <% if (consent.data_categories && consent.data_categories.length > 0) { %>
                                                            <%= consent.data_categories.join(', ') %>
                                                        <% } else { %>
                                                            Basic Profile
                                                        <% } %>
                                                    </small>
                                                </td>
                                                <td>
                                                    <small>
                                                        <%= consent.updated_at ? new Date(consent.updated_at).toLocaleDateString() : 'N/A' %>
                                                    </small>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <% if (consent.consent_given) { %>
                                                            <button class="btn btn-outline-danger btn-sm" onclick="revokeConsent(<%= consent.organization_id %>)">
                                                                Revoke
                                                            </button>
                                                        <% } else { %>
                                                            <button class="btn btn-outline-success btn-sm" onclick="grantConsent(<%= consent.organization_id %>)">
                                                                Approve
                                                            </button>
                                                        <% } %>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div class="text-center py-5">
                                <div class="text-muted mb-3">
                                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                </div>
                                <h5>No Consent Records</h5>
                                <p class="text-muted">You haven't granted any data consents yet.</p>
                                <% if (organizations && organizations.length > 0) { %>
                                    <div class="mt-3">
                                        <p class="text-muted mb-2">Available organizations to grant consent:</p>
                                        <div class="d-flex flex-wrap gap-2 justify-content-center">
                                            <% organizations.forEach(org => { %>
                                                <button class="btn btn-primary btn-sm" onclick="grantConsent(<%= org.id %>)">
                                                    Grant to <%= org.name %>
                                                </button>
                                            <% }) %>
                                        </div>
                                    </div>
                                <% } else { %>
                                    <p class="text-muted">No organizations available for consent.</p>
                                <% } %>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Sidebar -->
            <div class="col-lg-4">
                <!-- Data Rights Card -->
                <div class="pro-card mb-4">
                    <div class="pro-card-header">
                        <h6 class="mb-0">Exercise Your Data Rights</h6>
                    </div>
                    <div class="pro-card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-sm text-start" onclick="requestDataAccess()">
                                Request Data Access
                            </button>
                            <button class="btn btn-warning btn-sm text-start" onclick="requestDataCorrection()">
                                Request Data Correction
                            </button>
                            <button class="btn btn-danger btn-sm text-start" onclick="requestDataDeletion()">
                                Request Data Deletion
                            </button>
                            <button class="btn btn-info btn-sm text-start" onclick="downloadData()">
                                Download My Data
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Privacy Tips -->
                <div class="pro-card">
                    <div class="pro-card-body">
                        <h6>Privacy Tips</h6>
                        <ul class="small text-muted">
                            <li>Regularly review your data consents</li>
                            <li>Only share necessary information</li>
                            <li>Use strong, unique passwords</li>
                            <li>Enable two-factor authentication when available</li>
                            <li>Be cautious of unsolicited data requests</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for REAL interactive elements -->
    <script>
        // Real consent management with actual API calls
        async function grantConsent(organizationId) {
            if (confirm('Are you sure you want to grant consent to this organization?')) {
                try {
                    const response = await fetch('/grant-consent', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ organization_id: organizationId })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('Consent granted successfully!');
                        location.reload();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Failed to grant consent: ' + error.message);
                }
            }
        }

        async function revokeConsent(organizationId) {
            if (confirm('Are you sure you want to revoke consent? This may affect services.')) {
                try {
                    const response = await fetch('/revoke-consent', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ organization_id: organizationId })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('Consent revoked successfully!');
                        location.reload();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Failed to revoke consent: ' + error.message);
                }
            }
        }

        // Real data rights requests
        async function requestDataAccess() {
            try {
                const response = await fetch('/request-data-access', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                alert(result.message);
                location.reload(); // Refresh to update data rights count
            } catch (error) {
                alert('Failed to submit request: ' + error.message);
            }
        }

        async function requestDataCorrection() {
            try {
                const response = await fetch('/request-data-correction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                alert(result.message);
                location.reload(); // Refresh to update data rights count
            } catch (error) {
                alert('Failed to submit request: ' + error.message);
            }
        }

        async function requestDataDeletion() {
            if (confirm('This will request deletion of your data from all organizations. Continue?')) {
                try {
                    const response = await fetch('/request-data-deletion', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const result = await response.json();
                    alert(result.message);
                    location.reload(); // Refresh to update data rights count
                } catch (error) {
                    alert('Failed to submit request: ' + error.message);
                }
            }
        }

        async function downloadData() {
            try {
                const response = await fetch('/download-data');
                const result = await response.json();
                
                if (result.success) {
                    // Create a downloadable JSON file
                    const dataStr = JSON.stringify(result.data, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'mydatashield-data-export.json';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Failed to download data: ' + error.message);
            }
        }
    </script>

<%- include('partials/footer') %>